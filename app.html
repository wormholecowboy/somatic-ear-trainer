<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Somatic Ear Trainer</title>

    <link rel="stylesheet" type="text/css" href="style.css" />

    <script src="./tone/build/Tone.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tonaljs/tonal/browser/tonal.min.js"></script>
  </head>
  <body>
    <main>
      <h1>The Somatic Ear Trainer</h1>
      <h2 id="light">o</h2>
      <button id="run" onclick="run()">Start/Stop</button>
      <br />
      <select id="scaleLetter">
        <option>Ab</option>
        <option>A</option>
        <option>Bb</option>
        <option>B</option>
        <option>C</option>
        <option>Db</option>
        <option>D</option>
        <option>Eb</option>
        <option>F</option>
        <option>Gb</option>
        <option>G</option>
      </select>
      <select id="scaleTonality">
        <option value="major">Major</option>
        <option value="minor">Minor</option>
      </select>
      <br />
      <div id="range-selector">
        <select id="range-start"></select>
        <select id="range-end"></select>
      </div>
      <br />
      <!-- <select id="numOfNotes">
        <option>1</option>
        <option>2</option>
        <option>3</option>
        <option>4</option>
        <option>5</option>
        <option>6</option>
      </select> -->
      <div class="tooltip">
        <p id="ptag">20</p>
      </div>
      <input
        type="range"
        min="1"
        max="60"
        value="20"
        class="slider"
        id="speedSlider"
        oninput="displaySpeed(this.value);"
      />
      <br />
    </main>
    <script>
      // Globals
      const synthA = new Tone.Synth().toDestination();
      const chord = new Tone.PolySynth(Tone.Synth).toDestination();
      const loopA = new Tone.Loop(trigSynthA, '4n');
      const now = Tone.now();
      var selectedRangeOfNotes = [];
      'B2', 'C#3', 'D3', 'E3', 'F#3';
      var startStopState = false;
      var currentNote = 0;
      var previousNote = 0;
      let totalRange;
      let speed = 25;
      // HTML Elements
      let rangeStart = document.getElementById('range-start');
      let rangeEnd = document.getElementById('range-end');
      let rangeSlider = document.getElementById('speedSlider');
      let scaleTonality = document.getElementById('scaleTonality');
      let scaleLetter = document.getElementById('scaleLetter');

      // Start/Stop Button Function
      function run() {
        if (startStopState == true) {
          Tone.Transport.stop();
          startStopState = false;
          document.getElementById('light').style.color = 'red';
          console.log('stop');
        } else {
          startStopState = true;
          document.getElementById('light').style.color = 'green';
          console.log('start', selectedRangeOfNotes);

          Tone.start();
          startTransport();
        }
      }

      // Start Tone transport and set BPM
      function startTransport() {
        Tone.Transport.bpm.value = speed;
        Tone.Transport.start();
        loopA.start();
      }

      // Trigger the synth sounds
      function trigSynthA(time) {
        console.log('synthA time: ' + time);
        synthA.triggerAttackRelease(
          selectedRangeOfNotes[rando(0, selectedRangeOfNotes.length)],
          '16n'
        );
        console.log(`Random Index: ${currentNote}`);
      }

      // Phrase Trainer (Doesn't work yet)
      const phraseTrainer = new Tone.Loop((time) => {
        synthA.triggerAttackRelease(
          selectedRangeOfNotes[rando(0, selectedRangeOfNotes.length)],
          '32n'
        );
      }, '16n');

      // Grab random notes
      function rando(min, max) {
        min = Math.ceil(min);
        max = Math.floor(max);

        previousNote = currentNote;

        while (currentNote == previousNote) {
          currentNote = Math.floor(Math.random() * (max - min) + min);
        }
        return currentNote;
      }

      /* -----------------------------------------DOM Manipulation -----------------------------------
       ----------------------------------------------------------------------------------------------------*/

      // Set default values
      function setRangeEnd() {
        rangeEnd.value = rangeEnd.lastChild.value;
      }

      // Delete old nodes
      function deleteOldNodes() {
        while (rangeStart.hasChildNodes()) {
          rangeStart.removeChild(rangeStart.lastChild);
        }
        while (rangeEnd.hasChildNodes()) {
          rangeEnd.removeChild(rangeEnd.lastChild);
        }
      }

      function appendNewNodes() {
        for (let note of totalRange) {
          option = document.createElement('option');
          option2 = document.createElement('option');
          option.value = note;
          option.text = note;
          option2.value = note;
          option2.text = note;
          rangeStart.appendChild(option);
          rangeEnd.appendChild(option2);
        }
        rangeEnd.value = rangeEnd.lastChild.value;
      }

      // Changing notes from noteArray to the range selection boxes
      function appendScaleChanges() {
        // Grab scale from Tonal and set initial working range (totalRange)
        let getTonalRange = Tonal.Scale.rangeOf(
          `${scaleLetter.value} ${scaleTonality.value}`
        );
        totalRange = getTonalRange('A2', 'G5');
        console.log(totalRange);

        deleteOldNodes();
        appendNewNodes();
        filterNotesArray();
      }
      appendScaleChanges();

      function changeSpeed() {
        speed = rangeSlider.value;
        console.log(speed);
      }

      function displaySpeed() {
        document.getElementById('ptag').innerHTML = rangeSlider.value;
      }

      function filterNotesArray() {
        let firstNote = totalRange.indexOf(rangeStart.value);
        let lastNote = totalRange.indexOf(rangeEnd.value);
        console.log('First note index: ' + firstNote);
        console.log('Last note index: ' + lastNote);

        selectedRangeOfNotes = totalRange.slice(firstNote, lastNote + 1);
        console.log(selectedRangeOfNotes);
      }

      // EVENT LISTENERS
      document
        .getElementById('scaleLetter')
        .addEventListener('input', appendScaleChanges);
      document
        .getElementById('scaleTonality')
        .addEventListener('input', appendScaleChanges);
      document
        .getElementById('range-start')
        .addEventListener('input', filterNotesArray);
      document
        .getElementById('range-end')
        .addEventListener('input', filterNotesArray);
      document.getElementById('speedSlider').addEventListener('input', () => {
        changeSpeed();
        displaySpeed();
      });

      // Starting Defaults I like
      //scaleLetter.value = 'B';
      //scaleTonality.value = 'minor';
    </script>
  </body>
</html>
